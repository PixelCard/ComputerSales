@using ComputerSales.Application.Payment.VNPAY.Entity
@using System.Globalization
@model object

@{
    ViewData["Title"] = "Payment Failed";

    // Hỗ trợ cả model là string hoặc PaymentVNPAY_Response
    string msg = null, code = null, bank = null, txnNo = null, txnRef = null, payDate = null;
    if (Model is string s) { msg = s; }
    else if (Model is PaymentVNPAY_Response r)
    {
        code = r.VnPayResponseCode; txnNo = r.TransactionId; txnRef = r.OrderId;
    }

    // fallback: lấy từ query nếu thiếu
    var q = Context.Request?.Query;
    code ??= q?["vnp_ResponseCode"].ToString();
    bank ??= q?["vnp_BankCode"].ToString();
    txnNo ??= q?["vnp_TransactionNo"].ToString();
    txnRef ??= q?["vnp_TxnRef"].ToString();
    payDate ??= q?["vnp_PayDate"].ToString();

    if (DateTime.TryParseExact(payDate, "yyyyMMddHHmmss", CultureInfo.InvariantCulture,
                           DateTimeStyles.None, out var vnLocalTime))
    {
        // hiển thị kiểu Việt Nam
        payDate = vnLocalTime.ToString("dd/MM/yyyy HH:mm:ss"); // 29/09/2025 20:01:36
    }

    // Mặc định thông điệp
    msg ??= code switch
    {
        "24" => "Bạn đã hủy giao dịch.",
        "51" => "Số dư không đủ.",
        "07" => "Giao dịch nghi ngờ gian lận.",
        "09" => "Thẻ/Account chưa đăng ký InternetBanking.",
        "75" => "Ngân hàng tạm thời lỗi, vui lòng thử lại.",
        _ => "Thanh toán không thành công. Vui lòng thử lại hoặc chọn phương thức khác."
    };
}
<style>
    /* Page layout */
    html, body { height:100%; }
    body { margin:0; background: linear-gradient(135deg,#f5f7fa 0%, #c3cfe2 100%); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
    .page { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }

    /* Card */
    .card { width:100%; max-width:760px; background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 12px 30px rgba(0,0,0,.08); overflow:hidden; }
    .card-body { padding:24px; }
    @@media (min-width:640px){ .card-body{ padding:32px; } }

    /* Header banner */
    .banner { display:flex; align-items:center; gap:12px; background:#fee2e2; color:#b91c1c; border-bottom:1px solid #fecaca; padding:14px 20px; }
    .banner svg { color:#ef4444; }

    /* Typography */
    .title { font-size:22px; font-weight:700; color:#111827; margin:8px 0 4px; }
    .subtitle { color:#6b7280; }

    /* Buttons */
    .actions { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:18px; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:12px 18px; border-radius:10px; text-decoration:none; font-weight:600; transition:all .2s ease; }
    .btn-primary { background:#14b8a6; color:#fff; }
    .btn-primary:hover { background:#0d9488; }
    .btn-ghost { color:#111827; border:1px solid #e5e7eb; background:#fff; }
    .btn-ghost:hover { background:#f9fafb; }

    /* Details */
    details { margin-top:14px; }
    summary { cursor:pointer; color:#6b7280; }
    dl { margin-top:10px; display:grid; grid-template-columns: 160px 1fr; row-gap:8px; column-gap:12px; }
    dt { font-weight:600; color:#374151; }
    dd { margin:0; color:#111827; }

    /* Footer note */
    .note { margin-top:14px; color:#6b7280; }
</style>

<div class="page">
  <div class="card">
    <div class="banner">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v4m0 4h.01M7.8 20.4A9 9 0 1020.4 7.8 9 9 0 007.8 20.4z" />
      </svg>
      <strong>Thanh toán thất bại</strong>
    </div>

    <div class="card-body">
      <div style="text-align:center">
        <h1 class="title">Thanh toán không thành công</h1>
        <p class="subtitle">@msg</p>

        <div class="actions">
          <a class="btn btn-primary" asp-controller="Order" asp-action="OrderHome">Thử lại thanh toán</a>
          <a class="btn btn-ghost" asp-controller="Cart" asp-action="CartHome">Về giỏ hàng</a>
        </div>

        <details>
          <summary>Xem chi tiết kỹ thuật</summary>
          <dl>
            @if (!string.IsNullOrWhiteSpace(code))
            {
              <dt>Mã phản hồi</dt>
              <dd>@code</dd>
            }
            @if (!string.IsNullOrWhiteSpace(txnRef))
            {
              <dt>TxnRef</dt>
              <dd>@txnRef</dd>
            }
            @if (!string.IsNullOrWhiteSpace(txnNo))
            {
              <dt>TransactionNo</dt>
              <dd>@txnNo</dd>
            }
            @if (!string.IsNullOrWhiteSpace(bank))
            {
              <dt>Ngân hàng</dt>
              <dd>@bank</dd>
            }
            @if (!string.IsNullOrWhiteSpace(payDate))
            {
              <dt>Thời gian thanh toán</dt>
              <dd>@payDate</dd>
            }
          </dl>
        </details>

        <p class="note"><small>Nếu bạn đã bị trừ tiền nhưng đơn chưa tạo, vui lòng liên hệ CSKH kèm mã TxnRef/TransactionNo để được hỗ trợ đối soát.</small></p>
      </div>
    </div>
  </div>
</div>